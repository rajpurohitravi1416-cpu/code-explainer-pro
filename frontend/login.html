<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Code Explainer Pro | Login</title>

  <!-- Note: viewer script will be loaded lazily (to reduce initial load). -->
  <style>
    /* Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#0b1020; color: #fff; }

    /* Fullscreen 3D background placeholder & viewer container */
    .bg-wrap {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      background: #0b1020; /* fallback color while viewer loads */
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    /* when viewer exists it will fill this */
    .bg-3d {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      display:block;
    }

    /* light ball that follows the mouse */
    #cursor-ball {
      position: fixed;
      width: 18px;
      height: 18px;
      background: rgba(255,255,255,0.95);
      border-radius: 50%;
      pointer-events: none;
      mix-blend-mode: screen;
      filter: blur(6px) saturate(1.1);
      z-index: 2;
      transform: translate(-50%, -50%) scale(1);
      transition: transform 0.06s linear;
    }

    /* small animated pulsing dot (optional extra) */
    #cursor-ball::after {
      content: "";
      display:block;
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(255,255,255,0.95);
      position: absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      box-shadow: 0 0 18px rgba(255,255,255,0.12);
    }

    /* Login card (glass look) */
    .login-box {
      position: relative;
      z-index: 3;
      width: 360px;
      max-width: 92vw;
      margin: 40px;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(10px) saturate(1.05);
      padding: 28px;
      box-shadow: 0 24px 60px rgba(2,6,23,0.75);
      color: #fff;
    }
    .login-box h2 { font-size: 1.5rem; margin-bottom: 12px; letter-spacing: 0.02em; }
    .login-box p.lead { color: rgba(255,255,255,0.75); margin-bottom: 18px; font-size: 0.95rem; }

    label { display:block; font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-bottom:6px; }
    input[type="email"], input[type="password"], input[type="text"]{
      width:100%; padding:12px 14px; border-radius:10px; border: 1px solid rgba(255,255,255,0.06);
      background: rgba(10,12,15,0.35); color:#fff; outline:none; font-size:0.98rem;
    }
    input::placeholder { color: rgba(255,255,255,0.4); }

    .row { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:10px; }
    .login-btn {
      display:inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      border: 0;
      cursor: pointer;
      font-weight:700;
      background: linear-gradient(135deg,#6b2b5a,#7b3a66);
      color: #fff;
      box-shadow: 0 12px 30px rgba(123,58,102,0.15);
      transition: transform .12s ease;
    }
    .login-btn:active { transform: translateY(2px); }

    .links { display:flex; justify-content:space-between; margin-top:12px; font-size:0.95rem; }
    .links a { color: #d7bfd3; text-decoration:none; cursor:pointer; }
    .links a:hover { text-decoration:underline; }

    #errorMsg { margin-top:8px; color: #ffb3b3; min-height: 18px; font-size:0.9rem; }

    /* Signup / forgot modals */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(3,6,12,0.6); z-index: 20; display:none; align-items:center; justify-content:center;
    }
    .modal {
      width: 420px; max-width: 94vw; border-radius:16px; padding:20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(8px);
      color:#fff;
    }
    .modal h3 { margin-bottom:10px; }
    .modal .row { margin-top:8px; }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.08); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn-primary { background: linear-gradient(135deg,#38bdf8,#6366f1); color:#fff; border-radius:10px; padding:8px 12px; border:0; cursor:pointer; }

    /* loader while Spline loads */
    .loader {
      position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; z-index:1; pointer-events:none;
    }
    .spinner { width:40px; height:40px; border-radius:50%; border:4px solid rgba(255,255,255,0.08); border-top-color: rgba(255,255,255,0.22); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* small responsive layout: put login centered */
    @media (max-width:980px) {
      body { align-items: flex-start; justify-content:flex-start; }
      .login-box { margin-top: 6vh; }
    }
  </style>
</head>
<body>

  <!-- BACKGROUND / VIEWER WRAPPER -->
  <div class="bg-wrap" id="bgWrap">
    <!-- fallback loader shown while viewer not loaded -->
    <div class="loader" id="viewerLoader" aria-hidden="true">
      <div class="spinner" aria-hidden="true"></div>
    </div>

    <!-- spline viewer will be created and appended here lazily -->
    <div id="viewerContainer" style="width:100%;height:100%;"></div>
  </div>

  <!-- floating white ball that follows mouse -->
  <div id="cursor-ball" aria-hidden="true"></div>

  <!-- LOGIN BOX -->
  <main style="position:relative; z-index:3; display:flex; align-items:center; justify-content:center; min-height:100vh; padding:24px;">
    <section class="login-box" role="main" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Welcome to Code Explainer</h2>
      <p class="lead">Where your code becomes clarity.</p>

      <form id="loginForm" autocomplete="on" novalidate>
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required>

        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Enter password" autocomplete="current-password" required>

        <div style="display:flex; align-items:center; gap:12px; margin-top:10px;">
          <button type="submit" class="login-btn" id="loginBtn">Login</button>
          <div style="flex:1"></div>
          <div style="font-size:0.9rem; color:rgba(255,255,255,0.7)">Demo</div>
        </div>

        <p id="errorMsg" role="status" aria-live="polite"></p>

        <div class="links" style="margin-top:14px;">
          <!-- these links now open in-page modals instead of navigating away -->
          <a id="openSignup">Sign up</a>
          <a id="openForgot">Forgot Password</a>
        </div>
      </form>
    </section>
  </main>

  <!-- SIGNUP MODAL -->
  <div class="modal-backdrop" id="signupBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
      <h3 id="signupTitle">Create account</h3>
      <label for="suName">Name</label>
      <input id="suName" type="text" placeholder="Your name">

      <label for="suEmail">Email</label>
      <input id="suEmail" type="email" placeholder="you@example.com">

      <label for="suPassword">Password</label>
      <input id="suPassword" type="password" placeholder="Choose password">

      <div class="actions">
        <button class="btn-ghost" id="signupCancel">Cancel</button>
        <button class="btn-primary" id="signupSubmit">Create account</button>
      </div>

      <p id="signupMsg" style="margin-top:10px; color:#ffb3b3; min-height:18px"></p>
    </div>
  </div>

  <!-- FORGOT PASSWORD MODAL -->
  <div class="modal-backdrop" id="forgotBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="forgotTitle">
      <h3 id="forgotTitle">Reset password</h3>
      <label for="fpEmail">Email</label>
      <input id="fpEmail" type="email" placeholder="you@example.com">

      <div class="actions">
        <button class="btn-ghost" id="forgotCancel">Cancel</button>
        <button class="btn-primary" id="forgotSubmit">Send reset</button>
      </div>

      <p id="forgotMsg" style="margin-top:10px; color:#bfe3ff; min-height:18px"></p>
    </div>
  </div>

  <script>
  /*****************************************************************
   * 1) LAZY LOAD SPLINE VIEWER (improves initial load)
   *  - We'll inject the viewer script only after user interaction or after 1s.
   *  - Uses the URL you provided: prod.spline.design/qOo8h6XnBPPB7mtz/scene.splinecode
   *****************************************************************/
  (function lazyLoadSpline() {
    const SPLINE_URL = "https://prod.spline.design/qOo8h6XnBPPB7mtz/scene.splinecode";
    const viewerContainer = document.getElementById('viewerContainer');
    const loader = document.getElementById('viewerLoader');

    let splineLoaded = false;
    function createViewer() {
      if (splineLoaded) return;
      splineLoaded = true;
      // show loader
      loader.style.display = 'flex';

      // create module script for spline viewer
      const s = document.createElement('script');
      s.type = 'module';
      s.src = 'https://unpkg.com/@splinetool/viewer@1.12.5/build/spline-viewer.js';
      s.onload = () => {
        // create element after script loaded
        const sv = document.createElement('spline-viewer');
        sv.className = 'bg-3d';
        sv.setAttribute('url', SPLINE_URL);
        // optional: remove spline logo, enable/disable interactions via attributes
        sv.setAttribute('interaction', 'true');
        // append and hide spinner when viewer emits ready
        viewerContainer.appendChild(sv);

        // if available, use its "loaded" event — viewer doesn't always provide an event,
        // so we hide loader after a small delay to avoid flicker.
        setTimeout(() => loader.style.display = 'none', 900);
      };
      s.onerror = () => {
        loader.style.display = 'none';
        console.warn('Spline viewer failed to load from CDN.');
      };
      document.head.appendChild(s);
    }

    // Load after first mousemove or keydown or after 800ms, whichever comes first
    let triggered = false;
    function trigger() { if (!triggered) { triggered = true; createViewer(); removeListeners(); } }
    function removeListeners(){ window.removeEventListener('mousemove', trigger); window.removeEventListener('keydown', trigger); }

    window.addEventListener('mousemove', trigger, { once: true });
    window.addEventListener('keydown', trigger, { once: true });

    // fallback timer to load viewer if user doesn't interact
    setTimeout(trigger, 800);
  })();


  /*****************************************************************
   * 2) CURSOR BALL — follows mouse smoothly
   *****************************************************************/
  (function cursorBall() {
    const ball = document.getElementById('cursor-ball');
    let lastX = window.innerWidth/2, lastY = window.innerHeight/2;
    // show ball only when moving mouse (reduces GPU work)
    let visible = false, hideTimer = null;
    document.addEventListener('mousemove', (e) => {
      lastX = e.clientX; lastY = e.clientY;
      ball.style.left = `${lastX}px`;
      ball.style.top = `${lastY}px`;
      ball.style.transform = 'translate(-50%, -50%) scale(1)';
      if (!visible) {
        visible = true; ball.style.opacity = '1';
      }
      clearTimeout(hideTimer);
      hideTimer = setTimeout(()=>{ visible=false; ball.style.opacity='0.0'; }, 2000);
    }, { passive: true });

    // small parallax following for touch devices (touchmove)
    document.addEventListener('touchmove', (e) => {
      const t = e.touches[0];
      if (t) { ball.style.left = `${t.clientX}px`; ball.style.top = `${t.clientY}px`; }
    }, { passive: true });
  })();


  /*****************************************************************
   * 3) LOGIN + SIGNUP + FORGOT functionality (modal-based)
   *    - Attempts server calls; falls back to localStorage demo
   *****************************************************************/
  (function authForms(){
    const loginForm = document.getElementById('loginForm');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const errorMsg = document.getElementById('errorMsg');
    const loginBtn = document.getElementById('loginBtn');

    // Sign up modal
    const signupBackdrop = document.getElementById('signupBackdrop');
    const openSignup = document.getElementById('openSignup');
    const signupCancel = document.getElementById('signupCancel');
    const signupSubmit = document.getElementById('signupSubmit');
    const signupMsg = document.getElementById('signupMsg');

    // Forgot modal
    const forgotBackdrop = document.getElementById('forgotBackdrop');
    const openForgot = document.getElementById('openForgot');
    const forgotCancel = document.getElementById('forgotCancel');
    const forgotSubmit = document.getElementById('forgotSubmit');
    const forgotMsg = document.getElementById('forgotMsg');

    // open/close helpers
    openSignup.addEventListener('click', () => { signupBackdrop.style.display='flex'; signupBackdrop.setAttribute('aria-hidden','false'); });
    signupCancel.addEventListener('click', () => { signupBackdrop.style.display='none'; signupBackdrop.setAttribute('aria-hidden','true'); signupMsg.textContent = ''; });
    openForgot.addEventListener('click', () => { forgotBackdrop.style.display='flex'; forgotBackdrop.setAttribute('aria-hidden','false'); });
    forgotCancel.addEventListener('click', () => { forgotBackdrop.style.display='none'; forgotBackdrop.setAttribute('aria-hidden','true'); forgotMsg.textContent=''; });

    // clicking outside modal closes
    [signupBackdrop, forgotBackdrop].forEach(b => {
      b.addEventListener('click', (ev) => { if (ev.target === b) { b.style.display='none'; b.setAttribute('aria-hidden','true'); } });
    });

    // LOGIN handler (tries server then fallback)
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = '';
      const email = emailEl.value.trim();
      const password = passEl.value;

      if (!email || !password) {
        errorMsg.textContent = 'Please provide email and password.';
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      try {
        // try server
        const res = await fetch('/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          // server returned an error -> show message from server if available
          const json = await res.json().catch(()=>({}));
          throw new Error(json.message || `Server: ${res.status} ${res.statusText}`);
        }

        const data = await res.json().catch(()=>({}));
        if (data.token) {
          localStorage.setItem('token', data.token);
          window.location.href = 'index.html';
          return;
        } else {
          // server didn't return token -> fallback
          throw new Error('Server response missing token.');
        }
      } catch (err) {
        // fallback: local demo check (simple)
        console.warn('Login server error — falling back to demo:', err.message);
        const users = JSON.parse(localStorage.getItem('demo_users') || '{}');
        if (users[email] && users[email].password === password) {
          // demo success
          localStorage.setItem('token', 'demo-token-'+Date.now());
          loginBtn.textContent = 'Success!';
          setTimeout(()=> window.location.href = 'index.html', 600);
        } else {
          errorMsg.textContent = 'Unable to sign in. If you don\'t have an account, use Sign up.';
        }
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });

    // SIGNUP handler: tries POST /register then falls back to localStorage
    signupSubmit.addEventListener('click', async () => {
      signupMsg.textContent = '';
      const name = document.getElementById('suName').value.trim();
      const email = document.getElementById('suEmail').value.trim();
      const password = document.getElementById('suPassword').value;
      if (!email || !password) { signupMsg.textContent = 'Please enter email and password.'; return; }

      signupSubmit.disabled = true; signupSubmit.textContent = 'Creating...';
      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name, email, password })
        });
        if (res.ok) {
          signupMsg.style.color = '#bfe3ff';
          signupMsg.textContent = 'Account created. You can now sign in.';
          setTimeout(()=> { signupBackdrop.style.display='none'; signupBackdrop.setAttribute('aria-hidden','true'); signupMsg.textContent=''; }, 1000);
          return;
        } else {
          const json = await res.json().catch(()=>({}));
          throw new Error(json.message || `Server ${res.status}`);
        }
      } catch (err) {
        // fallback store locally for demo
        const users = JSON.parse(localStorage.getItem('demo_users') || '{}');
        if (users[email]) {
          signupMsg.style.color = '#ffb3b3';
          signupMsg.textContent = 'A demo account with this email already exists.';
        } else {
          users[email] = { name, password };
          localStorage.setItem('demo_users', JSON.stringify(users));
          signupMsg.style.color = '#bfe3ff';
          signupMsg.textContent = 'Demo account created locally. Use it to login.';
          setTimeout(()=> { signupBackdrop.style.display='none'; signupBackdrop.setAttribute('aria-hidden','true'); signupMsg.textContent=''; }, 1100);
        }
      } finally {
        signupSubmit.disabled = false; signupSubmit.textContent = 'Create account';
      }
    });

    // FORGOT handler: tries server then demo fallback
    forgotSubmit.addEventListener('click', async () => {
      forgotMsg.textContent = '';
      const email = document.getElementById('fpEmail').value.trim();
      if (!email) { forgotMsg.textContent = 'Please enter your email.'; return; }

      forgotSubmit.disabled = true; forgotSubmit.textContent = 'Sending...';
      try {
        const res = await fetch('/forgot-password', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email })
        });
        if (res.ok) {
          forgotMsg.style.color = '#bfe3ff';
          forgotMsg.textContent = 'If this email exists, a reset link was sent.';
          setTimeout(()=> { forgotBackdrop.style.display='none'; forgotBackdrop.setAttribute('aria-hidden','true'); forgotMsg.textContent=''; }, 900);
          return;
        } else {
          const json = await res.json().catch(()=>({}));
          throw new Error(json.message || `Server ${res.status}`);
        }
      } catch (err) {
        // demo fallback: simply say email sent (local)
        forgotMsg.style.color = '#bfe3ff';
        forgotMsg.textContent = 'Demo: reset instructions (no server).';
        setTimeout(()=> { forgotBackdrop.style.display='none'; forgotBackdrop.setAttribute('aria-hidden','true'); forgotMsg.textContent=''; }, 900);
      } finally {
        forgotSubmit.disabled = false; forgotSubmit.textContent = 'Send reset';
      }
    });
  })();


  /*****************************************************************
   * 4) OPTIONAL: move a small "white light" inside the Spline scene
   * We cannot directly control the internals of your Spline scene reliably
   * from outside, but we can overlay a small dot that appears to move and
   * even emit pointer events to create interactive feeling.
   *
   * The cursor ball is already doing that. If you want a second, larger
   * decorative dot that gently moves in response to mouse, we can add it:
   *****************************************************************/
  (function floatingDecoration(){
    // optional gentle follower for subtle parallax
    const bgWrap = document.getElementById('bgWrap');
    const dot = document.createElement('div');
    dot.style.position = 'absolute';
    dot.style.width = '34px';
    dot.style.height = '34px';
    dot.style.left = '10%';
    dot.style.top = '40%';
    dot.style.borderRadius = '50%';
    dot.style.pointerEvents = 'none';
    dot.style.background = 'radial-gradient(circle, rgba(255,255,255,0.85) 0%, rgba(255,255,255,0.06) 40%, transparent 70%)';
    dot.style.filter = 'blur(10px)';
    dot.style.opacity = '0.9';
    dot.style.zIndex = '1';
    bgWrap.appendChild(dot);

    let tx = 0, ty = 0;
    document.addEventListener('mousemove', (e) => {
      // position the dot relative to cursor for parallax feel
      const nx = (e.clientX / window.innerWidth - 0.5) * 30; // -15..15
      const ny = (e.clientY / window.innerHeight - 0.5) * 30;
      tx = 50 + nx; ty = 40 + ny;
      dot.style.left = `${tx}%`;
      dot.style.top = `${ty}%`;
    }, { passive: true });
  })();

  </script>
</body>
</html>
